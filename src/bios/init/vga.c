#include <stdint.h>
#include "utils.h"

typedef struct {
	uint8_t red;
	uint8_t green;
	uint8_t blue;
} rgb_t;

const rgb_t palette[0x10] = {
//       R,    G,    B
	{0x00, 0x00, 0x00},
	{0x00, 0x00, 0x2a},
	{0x00, 0x2a, 0x00},
	{0x00, 0x2a, 0x2a},
	{0x2a, 0x00, 0x00},
	{0x2a, 0x00, 0x2a},
	{0x2a, 0x15, 0x00},
	{0x2a, 0x2a, 0x2a},
	{0x15, 0x15, 0x15},
	{0x15, 0x15, 0x3f},
	{0x15, 0x3f, 0x15},
	{0x15, 0x3f, 0x3f},
	{0x3f, 0x15, 0x15},
	{0x3f, 0x15, 0x3f},
	{0x3f, 0x3f, 0x15},
	{0x3f, 0x3f, 0x3f}
};

static void config_crt(void);
static void config_attr(void);
static void config_dac(void);

void init_vga(void){
	cli();

	out_byte(0x3c2, 0x2);    // gr.msr = 2 (mem_ena)
	out_word(0x3ce, 0xff08); // gc.bmr = 0xff (bit mask)

	config_crt();
	config_attr();
	config_dac();

	asm volatile (
		"xor ax, ax\n"	// set mode 0
		"int 0x10\n"
	);

	sti();
}

static void config_crt(void){
	out_word(0x3b4, 0x0709); // mslr = 0x7 (scan_count : 8-1)
	out_word(0x3b4, 0x060a); // tcsr = 0x6 (cur_srt : 6)
	out_word(0x3b4, 0x270b); // tcer = 0x7 (cur_end : 7, cur_skew : 1)
}

static void config_attr(void){
	for(int i=0; i<0x10; i++){
		out_byte(0x3c0, i);
		out_byte(0x3c0, i);
	}
	out_byte(0x3c0, 0x10);
	out_byte(0x3c0, 0x08);  // mcr = 0x8 (ebsb_sel)
}

static void config_dac(void){
	out_byte(0x3c8, 0);
	for(int i=0; i<0x10; i++){
		out_byte(0x3c9, palette[i].red);
		out_byte(0x3c9, palette[i].green);
		out_byte(0x3c9, palette[i].blue);
	}
}
